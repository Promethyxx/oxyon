name: Rust CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache Cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    # Download build dependencies from the manually managed "assets" release
    - name: Download assets
      run: |
        New-Item -ItemType Directory -Force -Path bin
        gh release download assets --pattern "*.exe" --dir bin --repo ${{ github.repository }}
        Write-Host "Assets downloaded:"
        Get-ChildItem bin/*.exe | ForEach-Object { Write-Host "  - $($_.Name) ($([math]::Round($_.Length/1MB, 1)) MB)" }
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      shell: pwsh

    # Build full version (all features) — optimized for distribution
    - name: Build Full Version
      run: cargo build --profile dist

    - name: Prepare Full Binary
      run: Copy-Item target/dist/oxyon.exe oxyon-full.exe
      shell: pwsh

    # Build office version (minimal) — optimized for distribution
    - name: Build Office Version
      run: cargo build --profile dist --no-default-features

    - name: Prepare Office Binary
      run: Copy-Item target/dist/oxyon.exe oxyon-office.exe
      shell: pwsh

    # Deploy to GitHub
    - name: Deploy to GitHub Release
      uses: softprops/action-gh-release@v2
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      with:
        tag_name: latest
        body: |
          ### Available versions
          - **oxyon-full.exe** : Complete version (Archives, Audio, Docs, Pictures, Scrap, Tag, Video)
          - **oxyon-office.exe** : Office version (Docs, Pictures)

          Tools required for compilation are available in the [`assets` release](../../releases/tag/assets).

          *Last updated: ${{ github.event.head_commit.timestamp }}*
        files: |
          oxyon-full.exe
          oxyon-office.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Deploy to GitLab
    - name: Deploy to GitLab Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        $headers = @{
          "PRIVATE-TOKEN" = "${{ secrets.GITLAB_TOKEN }}"
        }
        
        # Get or create release
        try {
          $release = Invoke-RestMethod -Uri "https://gitlab.com/api/v4/projects/Promethyxx%2Foxyon/releases/latest" -Headers $headers -Method Get
          $releaseExists = $true
        } catch {
          $releaseExists = $false
        }
        
        # Upload binaries
        $files = @("oxyon-full.exe", "oxyon-office.exe")
        foreach ($file in $files) {
          $uploadResponse = Invoke-RestMethod -Uri "https://gitlab.com/api/v4/projects/Promethyxx%2Foxyon/uploads" -Headers $headers -Method Post -Form @{file = Get-Item $file}
          Write-Host "Uploaded $file : $($uploadResponse.url)"
        }
        
        # Create or update release
        $body = @{
          tag_name = "latest"
          name = "Rolling Release"
          description = @"
        ### Available versions
        - **oxyon-full.exe** : Complete version (Archives, Audio, Docs, Pictures, Scrap, Tag, Video)
        - **oxyon-office.exe** : Office version (Docs, Pictures)

        Tools required for compilation are available in the assets release.

        *Last updated: ${{ github.event.head_commit.timestamp }}*
        "@
        } | ConvertTo-Json
        
        if ($releaseExists) {
          Invoke-RestMethod -Uri "https://gitlab.com/api/v4/projects/Promethyxx%2Foxyon/releases/latest" -Headers $headers -Method Put -Body $body -ContentType "application/json"
        } else {
          Invoke-RestMethod -Uri "https://gitlab.com/api/v4/projects/Promethyxx%2Foxyon/releases" -Headers $headers -Method Post -Body $body -ContentType "application/json"
        }
      shell: pwsh